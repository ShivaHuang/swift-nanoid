name: Benchmarks

on:
  workflow_dispatch:
  pull_request:
    branches:
      - master
    paths:
      - 'Sources/NanoID/**'
      - 'Benchmarks/**'
      - 'Package.swift'

concurrency:
  group: benchmark-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Runs on PRs and manual dispatch ‚Äî compares branch vs master using baselines,
  # writes full diff to GitHub Step Summary, posts brief status to PR comment
  benchmark-delta:
    name: Benchmark PR vs master
    runs-on: ubuntu-latest
    container: swift:6.2
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mark repo safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install dependencies
        run: apt-get update -q && apt-get install -y -q libjemalloc-dev

      - name: Run benchmarks for PR branch
        run: |
          echo "exitStatus=1" >> $GITHUB_ENV
          swift package --package-path Benchmarks --disable-sandbox benchmark baseline update pull_request --no-progress

      - name: Add master worktree
        run: |
          git fetch --no-tags origin master
          git config --global --add safe.directory "$GITHUB_WORKSPACE/master-src"
          git worktree add master-src origin/master

      - name: Run benchmarks for master
        run: swift package --package-path master-src/Benchmarks --disable-sandbox benchmark baseline update master --no-progress

      - name: Collect master baseline
        run: cp -r master-src/Benchmarks/.benchmarkBaselines/. Benchmarks/.benchmarkBaselines/

      - name: Remove master worktree
        if: always()
        run: git worktree remove master-src --force || true

      - name: Compare PR vs master
        continue-on-error: true
        run: |
          set +e
          date >> $GITHUB_STEP_SUMMARY
          swift package --package-path Benchmarks --disable-sandbox benchmark baseline check master pull_request --format markdown >> $GITHUB_STEP_SUMMARY 2>benchmark_stderr
          swift_exit=$?
          cat benchmark_stderr >&2
          if grep -q "benchmarkThresholdImprovement" benchmark_stderr; then
            echo "exitStatus=4" >> $GITHUB_ENV
          elif grep -q "benchmarkThresholdRegression" benchmark_stderr; then
            echo "exitStatus=2" >> $GITHUB_ENV
          elif grep -q "benchmarkCrashed" benchmark_stderr; then
            echo "exitStatus=3" >> $GITHUB_ENV
          elif grep -q "baselineNotFound" benchmark_stderr; then
            echo "exitStatus=5" >> $GITHUB_ENV
          elif [ $swift_exit -eq 0 ]; then
            echo "exitStatus=0" >> $GITHUB_ENV
          fi

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const exitStatus = process.env.exitStatus;
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const statusMap = {
              '0': '‚úÖ No performance change detected.',
              '2': '‚ùå Performance regression detected.',
              '4': 'üöÄ Performance improvement detected.',
              '3': 'üí• Benchmark crashed.',
              '5': '‚ö†Ô∏è Baseline not found.',
            };
            const status = statusMap[exitStatus] ?? `‚ö†Ô∏è Unknown result (exit ${exitStatus}).`;
            const marker = '<!-- benchmark-delta -->';
            const body = `${marker}\n### Benchmark Comparison\n${status}\n[View full comparison ‚Üí](${runUrl})`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c =>
              c.user.login === 'github-actions[bot]' && c.body?.includes(marker)
            );
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Exit with correct status
        if: success() || failure()
        run: |
          status="${exitStatus:-1}"
          if [ "$status" = "0" ] || [ "$status" = "4" ]; then
            exit 0
          else
            exit "$status"
          fi

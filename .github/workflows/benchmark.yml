name: Benchmarks

on:
  workflow_dispatch:
  pull_request:
    branches:
      - master
    paths:
      - 'Sources/NanoID/**'
      - 'Benchmarks/**'
      - 'Package.swift'

concurrency:
  group: benchmark-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Runs on PRs and manual dispatch ‚Äî compares branch vs master using baselines,
  # writes full diff to GitHub Step Summary, posts brief status to PR comment,
  # and commits updated README to the PR branch on success
  benchmark-delta:
    name: Benchmark PR vs master
    runs-on: ubuntu-latest
    container: swift:6.2
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Mark repo safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install dependencies
        run: apt-get update -q && apt-get install -y -q libjemalloc-dev python3

      - name: Run benchmarks for PR branch
        shell: bash
        run: |
          echo "exitStatus=1" >> $GITHUB_ENV
          set -o pipefail
          NO_COLOR=1 swift package --package-path Benchmarks --disable-sandbox benchmark baseline update pull_request --no-progress 2>&1 | tee benchmark-results.txt

      - name: Switch to master sources
        run: git checkout origin/master -- Sources/ Package.swift

      - name: Run benchmarks for master
        run: swift package --package-path Benchmarks --disable-sandbox benchmark baseline update master --no-progress

      - name: Compare PR vs master
        continue-on-error: true
        run: |
          date >> $GITHUB_STEP_SUMMARY
          swift package --package-path Benchmarks benchmark baseline check master pull_request --format markdown >> $GITHUB_STEP_SUMMARY 2>benchmark_stderr
          cat benchmark_stderr >&2
          if grep -q "benchmarkThresholdImprovement" benchmark_stderr; then
            echo "exitStatus=4" >> $GITHUB_ENV
          elif grep -q "benchmarkThresholdRegression" benchmark_stderr; then
            echo "exitStatus=2" >> $GITHUB_ENV
          elif grep -q "benchmarkCrashed" benchmark_stderr; then
            echo "exitStatus=3" >> $GITHUB_ENV
          elif grep -q "baselineNotFound" benchmark_stderr; then
            echo "exitStatus=5" >> $GITHUB_ENV
          else
            echo "exitStatus=0" >> $GITHUB_ENV
          fi

      - name: Update README on PR branch
        if: github.event_name == 'pull_request' && (env.exitStatus == '0' || env.exitStatus == '4')
        run: |
          python3 - <<'EOF'
          import re
          results = open('benchmark-results.txt').read()
          readme = open('README.md').read()
          block = (
              '<!-- BENCHMARK_RESULTS_START -->\n'
              f'```\n{results}\n```\n'
              '<!-- BENCHMARK_RESULTS_END -->'
          )
          readme = re.sub(
              r'<!-- BENCHMARK_RESULTS_START -->.*?<!-- BENCHMARK_RESULTS_END -->',
              lambda _: block,
              readme,
              flags=re.DOTALL,
          )
          open('README.md', 'w').write(readme)
          EOF
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git diff --staged --quiet || git commit -m "chore: update benchmark results [skip ci]"
          git push origin HEAD:${{ github.head_ref }}

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const exitStatus = process.env.exitStatus;
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const statusMap = {
              '0': '‚úÖ No performance change detected.',
              '2': '‚ùå Performance regression detected.',
              '4': 'üöÄ Performance improvement detected.',
              '3': 'üí• Benchmark crashed.',
              '5': '‚ö†Ô∏è Baseline not found.',
            };
            const status = statusMap[exitStatus] ?? `‚ö†Ô∏è Unknown result (exit ${exitStatus}).`;
            const marker = '<!-- benchmark-delta -->';
            const body = `${marker}\n### Benchmark Comparison\n${status}\n[View full comparison ‚Üí](${runUrl})`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c =>
              c.user.login === 'github-actions[bot]' && c.body?.includes(marker)
            );
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Exit with correct status
        if: success() || failure()
        run: |
          if [ "${{ env.exitStatus }}" = "0" ] || [ "${{ env.exitStatus }}" = "4" ]; then
            exit 0
          else
            exit ${{ env.exitStatus }}
          fi
